<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é£Ÿå®‰æƒæ - AI ç‡Ÿé¤Šå¸«</title>
    
    <!-- iOS Web App è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="é£Ÿå®‰æƒæ">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2921/2921822.png">

    <!-- è¼‰å…¥ Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¼‰å…¥ React å’Œ Babel (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* iOS Safe Area */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        /* å‹•ç•«è¨­å®š */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scan { 
          0% { top: 10%; opacity: 0; } 
          50% { opacity: 1; }
          100% { top: 90%; opacity: 0; } 
        }
        .animate-fade-in { animation: fade-in 0.4s ease-out; }
        .animate-slide-up { animation: slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-scan { animation: scan 2.5s cubic-bezier(0.4, 0, 0.2, 1) infinite; }

        /* éš±è— Scrollbar ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-indigo-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICON Components (Inline SVG for single file portability) ---
        const Icons = {
            Camera: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Upload: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            ScanLine: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><line x1="7" x2="17" y1="12" y2="12"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Info: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            ChevronDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6 9 6 6 6-6"/></svg>,
            ChevronUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m18 15-6-6-6 6"/></svg>,
            Loader2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            History: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
            Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            AlertCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Key: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>
        };

        const MAX_HISTORY_ITEMS = 10;

        // --- Main Component ---
        function FoodDecoder() {
            const [apiKey, setApiKey] = useState('');
            const [showKeyInput, setShowKeyInput] = useState(false);
            const [activeTab, setActiveTab] = useState('scan');
            const [image, setImage] = useState(null);
            const [analyzing, setAnalyzing] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState(null);
            const [showCamera, setShowCamera] = useState(false);
            const [history, setHistory] = useState([]);
            const [showClearConfirm, setShowClearConfirm] = useState(false);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const keyInputRef = useRef(null);

            // Load API Key and History
            useEffect(() => {
                const storedKey = localStorage.getItem('gemini_api_key');
                if (storedKey) {
                    setApiKey(storedKey);
                } else {
                    setShowKeyInput(true);
                }

                try {
                    const savedHistory = localStorage.getItem('foodDecoderHistory');
                    if (savedHistory) setHistory(JSON.parse(savedHistory));
                } catch (e) {
                    localStorage.removeItem('foodDecoderHistory');
                }
            }, []);

            // Save History
            useEffect(() => {
                try {
                    localStorage.setItem('foodDecoderHistory', JSON.stringify(history));
                } catch (e) {
                    const trimmed = history.slice(0, 2);
                    setHistory(trimmed);
                    localStorage.setItem('foodDecoderHistory', JSON.stringify(trimmed));
                }
            }, [history]);

            // Save API Key
            const saveApiKey = () => {
                const key = keyInputRef.current.value.trim();
                if (key) {
                    localStorage.setItem('gemini_api_key', key);
                    setApiKey(key);
                    setShowKeyInput(false);
                }
            };

            const clearApiKey = () => {
                localStorage.removeItem('gemini_api_key');
                setApiKey('');
                setShowKeyInput(true);
            };

            // Image Compression
            const resizeImage = (base64Str, maxWidth = 800) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = base64Str;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                    };
                });
            };

            // Analyze
            const analyzeImageWithGemini = async (originalBase64) => {
                if (!apiKey) {
                    setShowKeyInput(true);
                    return;
                }

                setAnalyzing(true);
                setError(null);
                setResult(null);

                try {
                    const compressedDataUrl = await resizeImage(originalBase64);
                    const base64Image = compressedDataUrl.split(',')[1];

                    const prompt = `
                        ä½ ä¿‚ä¸€å€‹å°ˆæ¥­è€Œä¸”è¬›å˜¢å¥½ç›´ç™½å˜…é¦™æ¸¯ç‡Ÿé¤Šå¸« AIã€‚è«‹åˆ†æå‘¢å¼µé£Ÿå“æˆåˆ†è¡¨æˆ–è€…ç‡Ÿé¤Šæ¨™ç¤ºå˜…åœ–ç‰‡ã€‚
                        ä»»å‹™ï¼š
                        1. è­˜åˆ¥ç”¢å“åç¨±ï¼ˆå¦‚æœç‡å¾—åˆ°ï¼Œç‡å””åˆ°å°±æ ¹æ“šæˆåˆ†ä¼°å“ä¿‚å’©ï¼‰ã€‚
                        2. æµå‡ºæˆåˆ†åˆ—è¡¨ï¼Œå°‡è¤‡é›œå˜…åŒ–å­¸åè©ç¿»è­¯æˆé¦™æ¸¯äººè½å¾—æ˜å˜…ã€Œç™½è©±æ–‡ã€ï¼ˆå»£æ±è©±ï¼‰ã€‚
                        3. è­˜åˆ¥ç†±é‡è³‡è¨Šã€‚
                        4. **è­˜åˆ¥å¸¸è¦‹è‡´æ•åŸï¼ˆä¾‹å¦‚ç‰›å¥¶ã€è›‹ã€å¤§è±†ã€å …æœã€ç”²æ®¼é¡ã€éº©è³ªç­‰ï¼‰ã€‚**
                        5. ä¿¾ä¸€å€‹ç¸½è©•ï¼šä¿‚ã€Œå„ªè³ªç‡Ÿé¤Šã€ã€ã€Œæ™®é€šé£Ÿå“ã€å®šä¿‚ã€Œç†±é‡/åŒ–å­¸é™·é˜±ã€ã€‚
                        
                        è«‹å‹™å¿…åš´æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼å›å‚³ï¼ˆæ·¨ä¿‚è¦ JSONï¼‰ï¼š
                        {
                          "productName": "ç”¢å“åç¨±",
                          "healthScore": 0åˆ°100å˜…æ•´æ•¸,
                          "verdictTitle": "ç°¡çŸ­æœ‰åŠ›å˜…æ¨™é¡Œ (ä¾‹å¦‚ï¼šå¥èº«æ©ç‰© / ç³–ä»½ç‚¸å½ˆ)",
                          "verdictType": "good" | "average" | "bad",
                          "calories": "ç†±é‡æè¿°",
                          "allergens": ["è‡´æ•åŸ1"] (å†‡å°±ç©ºé™£åˆ—),
                          "ingredients": [
                            {
                              "name": "åŸå§‹æˆåˆ†å",
                              "translation": "å»£æ±è©±ç™½è©±æ–‡",
                              "risk": "low" | "medium" | "high",
                              "description": "ç°¡çŸ­èªªæ˜"
                            }
                          ],
                          "advice": "ä¿¾æ¶ˆè²»è€…å˜…ç¸½çµå»ºè­°ï¼Œèªæ°£è¦ä¼¼æœ‹å‹å’ç›´ç™½ï¼Œç”¨åœ°é“å»£æ±è©±ï¼Œå¤§ç´„50å­—ã€‚"
                        }
                    `;

                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: prompt },
                                        { inlineData: { mimeType: "image/jpeg", data: base64Image } }
                                    ]
                                }],
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        }
                    );

                    if (!response.ok) {
                         if (response.status === 400 || response.status === 403) {
                             throw new Error("API Key å¯èƒ½éŒ¯å’—æˆ–è€…éæœŸï¼Œè«‹é‡è¨­ Keyã€‚");
                         }
                        throw new Error(`API Error: ${response.statusText}`);
                    }

                    const data = await response.json();
                    const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!textResponse) throw new Error("AI å†‡åæ‡‰");

                    const cleanJson = textResponse.replace(/```json|```/g, '').trim();
                    const parsedResult = JSON.parse(cleanJson);
                    
                    const fullResult = {
                        ...parsedResult,
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        thumbnail: compressedDataUrl 
                    };

                    setResult(fullResult);
                    setHistory(prev => [fullResult, ...prev].slice(0, MAX_HISTORY_ITEMS));

                } catch (err) {
                    console.error("Analysis failed:", err);
                    setError(err.message || "åˆ†æå””åˆ°ï¼Œè«‹ç¢ºä¿å¼µç›¸æ¸…æ™°ã€‚");
                } finally {
                    setAnalyzing(false);
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setImage(reader.result);
                        analyzeImageWithGemini(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = '';
            };

            const startCamera = async () => {
                setShowCamera(true);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    if (videoRef.current) videoRef.current.srcObject = stream;
                } catch (err) {
                    setError("é–‹å””åˆ°ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™ã€‚");
                    setShowCamera(false);
                }
            };

            const capturePhoto = () => {
                if (videoRef.current && canvasRef.current) {
                    const video = videoRef.current;
                    const canvas = canvasRef.current;
                    if (video.videoWidth === 0) return;
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg');
                    setImage(dataUrl);
                    
                    // Stop Stream
                    if (videoRef.current?.srcObject) {
                        videoRef.current.srcObject.getTracks().forEach(t => t.stop());
                    }
                    setShowCamera(false);
                    analyzeImageWithGemini(dataUrl);
                }
            };

            const closeCamera = () => {
                if (videoRef.current?.srcObject) {
                    videoRef.current.srcObject.getTracks().forEach(t => t.stop());
                }
                setShowCamera(false);
            };

            // Components
            const VerdictBadge = ({ type, score, title }) => {
                const config = {
                    good: { gradient: "from-emerald-500 to-teal-600", bg: "bg-emerald-50", border: "border-emerald-100", text: "text-emerald-800", icon: Icons.CheckCircle, label: "å„ªè³ªä¹‹é¸" },
                    average: { gradient: "from-amber-400 to-orange-500", bg: "bg-amber-50", border: "border-amber-100", text: "text-amber-800", icon: Icons.Info, label: "æ™®é€šé£Ÿå“" },
                    bad: { gradient: "from-rose-500 to-pink-600", bg: "bg-rose-50", border: "border-rose-100", text: "text-rose-800", icon: Icons.AlertTriangle, label: "ç†±é‡é™·é˜±" }
                };
                const current = config[type] || config.average;
                const Icon = current.icon;

                return (
                    <div className={`relative overflow-hidden rounded-2xl border ${current.border} ${current.bg} shadow-lg mb-6`}>
                        <div className="absolute top-0 right-0 p-4 opacity-10"><Icon width="120" height="120" /></div>
                        <div className="relative p-5 z-10">
                            <div className="flex justify-between items-start">
                                <div className="space-y-1">
                                    <div className="flex items-center gap-2">
                                        <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-white/50 border border-white/20 ${current.text}`}>{current.label}</span>
                                    </div>
                                    <h2 className={`text-2xl font-black ${current.text} tracking-tight`}>{title}</h2>
                                </div>
                                <div className={`flex flex-col items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br ${current.gradient} text-white shadow-md`}>
                                    <span className="text-2xl font-black">{score}</span>
                                    <span className="text-[10px] font-medium opacity-80">åˆ†</span>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const IngredientRow = ({ item }) => {
                const [isOpen, setIsOpen] = React.useState(false);
                const riskColor = {
                    low: "bg-emerald-50/50 border-emerald-100 text-emerald-900",
                    medium: "bg-white border-slate-100 text-slate-700",
                    high: "bg-rose-50 border-rose-100 text-rose-900"
                };

                return (
                    <div className={`group mb-2 rounded-xl border transition-all duration-300 ${isOpen ? 'shadow-md ring-1 ring-slate-200' : 'shadow-sm hover:shadow-md'} ${riskColor[item.risk] || riskColor.medium}`}>
                        <div className="p-3.5 flex items-center justify-between cursor-pointer" onClick={() => setIsOpen(!isOpen)}>
                            <div className="flex-1 min-w-0 pr-4">
                                <div className="flex items-center flex-wrap gap-2">
                                    <span className="font-bold text-base text-slate-800">{item.translation}</span>
                                    {item.risk === 'high' && <span className="text-[10px] bg-rose-100 text-rose-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-wider flex items-center gap-1"><Icons.AlertCircle width="10" height="10" /> è­¦ç¤º</span>}
                                </div>
                                <div className="text-xs text-slate-400 mt-1 truncate font-mono tracking-tight">{item.name}</div>
                            </div>
                            <div className={`p-1.5 rounded-full transition-colors ${isOpen ? 'bg-slate-100 text-slate-600' : 'text-slate-300 group-hover:text-slate-500'}`}>
                                {isOpen ? <Icons.ChevronUp width="16" height="16" /> : <Icons.ChevronDown width="16" height="16" />}
                            </div>
                        </div>
                        {isOpen && <div className="px-4 pb-4 pt-0 text-sm text-slate-600 leading-relaxed border-t border-dashed border-slate-200 pt-3 mx-3">{item.description}</div>}
                    </div>
                );
            };

            return (
                <div className="min-h-screen pb-safe">
                    {/* Header */}
                    <header className="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-20 transition-all border-b border-white/50 pt-safe">
                        <div className="max-w-md mx-auto px-4 h-14 flex items-center justify-center relative">
                            <div className="flex items-center gap-2 cursor-pointer absolute left-4 active:scale-95 transition-transform" onClick={() => { setActiveTab('scan'); setImage(null); setResult(null); }}>
                                <div className="w-8 h-8 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                                    <Icons.ScanLine width="16" height="16" strokeWidth="2.5" />
                                </div>
                                <h1 className="text-lg font-black tracking-tight text-slate-800">é£Ÿå®‰æƒæ</h1>
                            </div>
                            {/* Key Setting Button */}
                             <button onClick={() => setShowKeyInput(true)} className="absolute right-4 p-2 text-slate-400 hover:text-indigo-600 active:scale-95">
                                <Icons.Key width="20" height="20" />
                            </button>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto min-h-[calc(100vh-140px)]">
                        {activeTab === 'scan' ? (
                            <div className="pb-28">
                                {/* Empty State */}
                                {!image && !showCamera && (
                                    <div className="flex flex-col items-center justify-center min-h-[60vh] px-6 animate-fade-in">
                                        <div className="w-full max-w-sm space-y-8">
                                            <div className="text-center space-y-3">
                                                <h2 className="text-3xl font-black text-slate-800">
                                                    <span className="bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-violet-600">ç‡å””æ˜</span><span> æˆåˆ†è¡¨ï¼Ÿ</span>
                                                </h2>
                                                <p className="text-slate-500 text-base leading-relaxed">å½±å¼µç›¸ï¼ŒAI å¹«ä½ ç¿»è­¯ã€ŒåŒ–å­¸å¯†ç¢¼ã€<br/>ä¸€çœ¼ç‡ç©¿ä¿‚å„ªè³ªç‡Ÿé¤Šå®šä¿‚ç†±é‡é™·é˜±</p>
                                            </div>
                                            <div className="bg-white p-6 rounded-3xl shadow-xl shadow-indigo-100/50 border border-white">
                                                <div className="grid grid-cols-2 gap-4">
                                                    <button className="group relative flex flex-col items-center gap-3 p-5 bg-gradient-to-b from-indigo-50 to-white rounded-2xl border border-indigo-100 cursor-pointer hover:shadow-md transition-all active:scale-[0.98]" onClick={() => document.getElementById('file-upload').click()}>
                                                        <div className="w-14 h-14 bg-white rounded-full flex items-center justify-center text-indigo-600 shadow-sm group-hover:scale-110 transition-transform duration-300"><Icons.Upload width="24" height="24" /></div>
                                                        <span className="font-bold text-slate-700">ä¸Šå‚³åœ–ç‰‡</span>
                                                    </button>
                                                    <button className="group relative flex flex-col items-center gap-3 p-5 bg-gradient-to-b from-violet-50 to-white rounded-2xl border border-violet-100 cursor-pointer hover:shadow-md transition-all active:scale-[0.98]" onClick={startCamera}>
                                                        <div className="w-14 h-14 bg-indigo-600 rounded-full flex items-center justify-center text-white shadow-indigo-200 shadow-lg group-hover:scale-110 transition-transform duration-300"><Icons.Camera width="24" height="24" /></div>
                                                        <span className="font-bold text-slate-700">å½±å¼µç›¸</span>
                                                    </button>
                                                </div>
                                                <input id="file-upload" type="file" accept="image/*" className="hidden" onChange={handleFileUpload} />
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Analyzing */}
                                {image && analyzing && (
                                    <div className="text-center py-20 px-6 animate-fade-in flex flex-col items-center">
                                        <div className="relative w-40 h-40 mb-8">
                                            <div className="absolute inset-0 bg-indigo-500/10 rounded-full animate-ping"></div>
                                            <img src={image} alt="Analyzing" className="w-full h-full object-cover rounded-full border-4 border-white shadow-xl opacity-80" />
                                            <div className="absolute inset-0 flex items-center justify-center">
                                                <div className="bg-white/90 p-4 rounded-full shadow-lg backdrop-blur-sm"><Icons.Loader2 className="animate-spin text-indigo-600" width="32" height="32" /></div>
                                            </div>
                                        </div>
                                        <h3 className="text-xl font-bold text-slate-800 mb-2">è§£è®€ç·Šæˆåˆ†...</h3>
                                        <p className="text-slate-500 text-sm animate-pulse">AI æŸ¥ç·ŠåŒ–å­¸å­—å…¸ï¼Œå¹«ä½ é¿é–‹åœ°é›·</p>
                                    </div>
                                )}

                                {/* Error */}
                                {error && (
                                    <div className="mx-4 mt-8 bg-rose-50/80 backdrop-blur-sm p-6 rounded-2xl border border-rose-100 text-center space-y-4 animate-fade-in shadow-sm">
                                        <div className="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center mx-auto text-rose-500"><Icons.AlertTriangle width="24" height="24" /></div>
                                        <div className="space-y-1"><h3 className="font-bold text-rose-900">åˆ†æå¤±æ•—</h3><p className="text-sm text-rose-700/80">{error}</p></div>
                                        <button onClick={() => { setImage(null); setError(null); }} className="w-full py-3 bg-white border border-rose-200 rounded-xl text-rose-600 text-sm font-bold hover:bg-rose-50 transition-colors">è©¦å¤šæ¬¡</button>
                                    </div>
                                )}

                                {/* Result */}
                                {result && !analyzing && (
                                    <div className="px-4 pt-4 space-y-6 animate-slide-up">
                                        <div className="flex items-center gap-3 bg-white/80 backdrop-blur-md p-2 pr-4 rounded-full shadow-sm border border-white w-fit mx-auto mb-2">
                                            <img src={image} alt="Product" className="w-8 h-8 object-cover rounded-full ring-2 ring-white shadow-sm" />
                                            <div className="font-bold text-slate-700 text-sm truncate max-w-[200px]">{result.productName || "æœªçŸ¥ç”¢å“"}</div>
                                        </div>
                                        
                                        <VerdictBadge type={result.verdictType} score={result.healthScore} title={result.verdictTitle} />

                                        {result.allergens && result.allergens.length > 0 && (
                                            <div className="bg-amber-50 border border-amber-100 p-4 rounded-xl text-amber-900 text-sm shadow-sm flex items-start gap-3">
                                                <Icons.AlertCircle className="flex-shrink-0 text-amber-500" width="20" height="20" />
                                                <div><div className="font-bold mb-1">è‡´æ•åŸæç¤º</div><div className="opacity-90">æœ‰ï¼š{result.allergens.join('ã€')}</div></div>
                                            </div>
                                        )}

                                        <div className="bg-gradient-to-br from-indigo-600 to-violet-700 text-white p-6 rounded-2xl shadow-lg shadow-indigo-200 relative overflow-hidden group">
                                            <div className="relative z-10">
                                                <div className="flex items-center gap-2 mb-3 font-bold text-indigo-100 text-xs tracking-wider uppercase"><Icons.Sparkles width="12" height="12" /> AI ç‡Ÿé¤Šå¸«å»ºè­°</div>
                                                <p className="font-medium text-lg leading-relaxed tracking-wide text-white/95">"{result.advice}"</p>
                                            </div>
                                            <div className="absolute -top-12 -right-12 w-40 h-40 bg-white opacity-10 rounded-full blur-3xl"></div>
                                        </div>

                                        <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                                            <div className="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-500"><span className="text-lg">ğŸ”¥</span></div>
                                            <div><h3 className="font-bold text-slate-800 text-sm uppercase tracking-wider mb-0.5">ç†±é‡åˆ†æ</h3><p className="text-slate-600 text-sm">{result.calories}</p></div>
                                        </div>

                                        <div className="pt-2">
                                            <h3 className="font-bold text-slate-800 mb-4 px-1 flex items-center justify-between text-sm uppercase tracking-wide">
                                                <span className="flex items-center gap-2"><span className="w-1 h-4 bg-indigo-500 rounded-full"></span>æˆåˆ†ç™½è©±æ–‡</span>
                                                <span className="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-full">{result.ingredients.length} ç¨®æˆåˆ†</span>
                                            </h3>
                                            <div className="space-y-3">{result.ingredients.map((item, idx) => <IngredientRow key={idx} item={item} />)}</div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            // History View
                            <div className="px-4 pt-6 pb-28 animate-fade-in relative">
                                <div className="flex items-center justify-between mb-6 sticky top-0 bg-slate-50/90 backdrop-blur-sm z-10 py-2">
                                    <h2 className="text-2xl font-black text-slate-800">æ­·å²ç´€éŒ„</h2>
                                    {history.length > 0 && <button onClick={() => setShowClearConfirm(true)} className="text-xs text-rose-500 flex items-center gap-1.5 px-3 py-1.5 bg-rose-50 hover:bg-rose-100 rounded-full font-bold transition-colors"><Icons.Trash2 width="12" height="12" /> æ¸…é™¤</button>}
                                </div>
                                {history.length === 0 ? (
                                    <div className="text-center py-20 opacity-40">
                                        <div className="flex justify-center mb-4"><Icons.History width="80" height="80" className="text-slate-300"/></div>
                                        <p className="font-medium text-slate-500">æš«æ™‚æœªæœ‰ç´€éŒ„</p>
                                    </div>
                                ) : (
                                    <div className="grid gap-4">
                                        {history.map((item) => (
                                            <div key={item.id} className="group bg-white p-3 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer flex gap-4" onClick={() => { setResult(item); setImage(item.thumbnail); setActiveTab('scan'); }}>
                                                <div className="w-20 h-20 rounded-xl bg-slate-100 overflow-hidden flex-shrink-0 relative">
                                                    <img src={item.thumbnail} className="w-full h-full object-cover" alt="History" />
                                                    <div className={`absolute bottom-0 inset-x-0 h-1 ${item.verdictType === 'good' ? 'bg-emerald-500' : item.verdictType === 'bad' ? 'bg-rose-500' : 'bg-amber-400'}`}></div>
                                                </div>
                                                <div className="flex-1 min-w-0 py-1 flex flex-col justify-between">
                                                    <div>
                                                        <div className="flex justify-between items-start mb-1"><h3 className="font-bold text-slate-800 truncate text-base">{item.productName}</h3></div>
                                                        <p className="text-xs text-slate-500 line-clamp-2 leading-relaxed">{item.advice}</p>
                                                    </div>
                                                    <div className="flex items-center justify-between mt-2">
                                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${item.verdictType === 'good' ? 'bg-emerald-50 text-emerald-700' : item.verdictType === 'bad' ? 'bg-rose-50 text-rose-700' : 'bg-amber-50 text-amber-700'}`}>{item.healthScore} åˆ†</span>
                                                        <span className="text-[10px] text-slate-300 font-medium">{new Date(item.timestamp).toLocaleDateString()}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {/* Navigation */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 pb-safe z-30">
                        <div className="max-w-md mx-auto flex justify-around p-2">
                            <button onClick={() => setActiveTab('scan')} className={`relative flex flex-col items-center gap-1 p-2 rounded-2xl flex-1 transition-all duration-300 ${activeTab === 'scan' ? 'text-indigo-600' : 'text-slate-400 hover:bg-slate-50'}`}>
                                <div className={`p-1.5 rounded-xl transition-all ${activeTab === 'scan' ? 'bg-indigo-50 translate-y-[-2px]' : ''}`}><Icons.Camera width="24" height="24" strokeWidth={activeTab === 'scan' ? 2.5 : 2} /></div>
                                <span className="text-[10px] font-bold">æƒæ</span>
                            </button>
                            <button onClick={() => setActiveTab('history')} className={`relative flex flex-col items-center gap-1 p-2 rounded-2xl flex-1 transition-all duration-300 ${activeTab === 'history' ? 'text-indigo-600' : 'text-slate-400 hover:bg-slate-50'}`}>
                                <div className={`p-1.5 rounded-xl transition-all ${activeTab === 'history' ? 'bg-indigo-50 translate-y-[-2px]' : ''}`}><Icons.History width="24" height="24" strokeWidth={activeTab === 'history' ? 2.5 : 2} /></div>
                                <span className="text-[10px] font-bold">ç´€éŒ„</span>
                            </button>
                        </div>
                    </nav>

                    {/* Camera Modal */}
                    {showCamera && (
                        <div className="fixed inset-0 bg-black z-50 flex flex-col animate-fade-in">
                            <div className="relative flex-1 bg-black overflow-hidden">
                                <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover opacity-90"></video>
                                <canvas ref={canvasRef} className="hidden"></canvas>
                                <div className="absolute inset-0 m-8 pointer-events-none">
                                    <div className="w-full h-full border-2 border-white/20 rounded-3xl relative">
                                        <div className="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-white rounded-tl-xl shadow-sm"></div>
                                        <div className="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-white rounded-tr-xl shadow-sm"></div>
                                        <div className="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-white rounded-bl-xl shadow-sm"></div>
                                        <div className="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-white rounded-br-xl shadow-sm"></div>
                                        <div className="absolute left-0 right-0 h-0.5 bg-indigo-500/80 shadow-[0_0_15px_rgba(99,102,241,0.8)] animate-scan top-1/2"></div>
                                    </div>
                                </div>
                                <div className="absolute top-12 left-0 right-0 text-center"><div className="inline-block px-4 py-2 bg-black/50 backdrop-blur-md rounded-full text-white/90 text-sm font-medium border border-white/10">å°‡æˆåˆ†è¡¨å°æº–å€‹æ¡†</div></div>
                            </div>
                            <div className="h-40 bg-black flex items-center justify-center gap-10 pb-6 pb-safe">
                                <button onClick={closeCamera} className="p-4 rounded-full bg-slate-800/80 text-white hover:bg-slate-700 transition-colors backdrop-blur-sm active:scale-95"><Icons.X width="24" height="24" /></button>
                                <button onClick={capturePhoto} className="p-2 rounded-full border-4 border-white transition-transform active:scale-95 shadow-lg"><div className="w-16 h-16 bg-white rounded-full flex items-center justify-center"><div className="w-14 h-14 rounded-full border-2 border-slate-200"></div></div></button>
                                <div className="w-14"></div>
                            </div>
                        </div>
                    )}

                    {/* Clear Confirm Modal */}
                    {showClearConfirm && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white rounded-2xl p-6 shadow-2xl max-w-xs w-full animate-slide-up">
                                <h3 className="text-lg font-bold text-slate-800 mb-2">æ¸…æ™’æ‰€æœ‰ç´€éŒ„ï¼Ÿ</h3>
                                <p className="text-slate-500 text-sm mb-6">æ¸…å’—å°±å†‡å¾—è¿”è½‰é ­ï¼Œä¿‚å’ªç¢ºå®šè¦æ¸…ç©ºï¼Ÿ</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowClearConfirm(false)} className="flex-1 py-2 rounded-xl bg-slate-100 text-slate-700 font-bold text-sm hover:bg-slate-200 transition-colors">å–æ¶ˆ</button>
                                    <button onClick={() => { setHistory([]); setShowClearConfirm(false); }} className="flex-1 py-2 rounded-xl bg-rose-500 text-white font-bold text-sm shadow-rose-200 shadow-lg hover:bg-rose-600 transition-colors">ç¢ºèªæ¸…é™¤</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* API Key Modal */}
                    {showKeyInput && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-md animate-fade-in">
                            <div className="bg-white rounded-2xl p-6 shadow-2xl max-w-sm w-full animate-slide-up">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold text-slate-800">è¨­å®š API Key</h3>
                                    {apiKey && <button onClick={() => setShowKeyInput(false)} className="text-slate-400 hover:text-slate-600"><Icons.X width="20" height="20"/></button>}
                                </div>
                                <p className="text-slate-500 text-sm mb-4">å› ç‚ºå‘¢å€‹ App ä¿‚éœæ…‹ç¶²é ï¼Œä½ éœ€è¦è¼¸å…¥è‡ªå·±å˜… Google Gemini API Key å…ˆç”¨å¾—ã€‚</p>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-700 uppercase mb-1">Gemini API Key</label>
                                        <input ref={keyInputRef} defaultValue={apiKey} type="password" placeholder="AIzaSy..." className="w-full p-3 rounded-xl border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all font-mono text-sm" />
                                    </div>
                                    <button onClick={saveApiKey} className="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-colors">å„²å­˜ä¸¦é–‹å§‹</button>
                                    <div className="text-center">
                                        <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-indigo-500 hover:text-indigo-700 underline">ğŸ‘‰ æŒ‰æ­¤å…è²»ç²å– API Key</a>
                                    </div>
                                    {apiKey && (
                                        <button onClick={clearApiKey} className="text-xs text-rose-500 hover:text-rose-700 w-full mt-2">æ¸…é™¤ç›®å‰çš„ Key</button>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FoodDecoder />);
    </script>
</body>
</html>
